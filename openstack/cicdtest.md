# 1. CICD测试

## 1.1 Cloud Test

随着云扩容需求激增，通常的验收测试效率已经不能满足诉求，继续打通从研发到生产环境的自动化能力共享通道，在研发区能直接部署现网自动化，利用自动化进行扩容局点的验收测试。<br>
![云测试](images/cloudtest-001.jpg)
- 基于APITest，测试框架归一化、测试环境标准化，不同局点复用测试环境及脚本，实现资源最大化利用:<br>
![云测试](images/cloudtest-002.jpg)
- 实践DNA2-突破内外网隔离：<br>
基于APITest跨区域融合测试方案，打通研发内外网测试工具协同通道，构建短平快测试能力，基于任务环境变量可配置方式实现单个用例在多个服务、多个局点零成本在线复用，已在华为云、TLF合营云验收测试使用，验收测试周期由15天缩短至7天，效率提升1倍，实现类生产与生产环境秒级切换
![云测试](images/cloudtest-003.jpg)
- 实践DNA3-备案网络跨区访问场景：<br>
复用测试脚本和执行器，需跨网络区域访问，涉及信息安全风险，通过设计具体跨网络区域访问场景，并在产品线信息安全部门进行评审备案，扫清信息安全障碍.
![云测试](images/cloudtest-004.jpg)
- 落地效果- 基于APITest实现验收测试框架统一化，测试环境标准化，成本降低3倍，实现25个服务325个验收测试用例自动化，在验收测试中，验收测试周期由15天缩短至7天，效率提升1倍；<br>
![云测试](images/cloudtest-005.jpg)
- 落地效果（优秀DNA复制）—媒体云服务基于APITest实现3个服务434个OpenAPI接口测试用例自动化，通过配置VPN方案直接对蓝区公有云类生产环境进行接口验收看护，提升验收测试效率XX倍。<br>
![云测试](images/cloudtest-006.jpg)

## 1.2 灰度自动化验证（基于OnTest）

### 1.2.1 背景

灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式，可以保证整体系统的稳定，在初始灰度的时候发现、调整问题，以保证其影响度。简单理解是对某一产品先让小部分用户使用，观察这小部分用户使用的效果，如果效果不佳则进行版本回退，否则逐步扩大使用群体范围，最后到全网发布。

如何获知灰度发布效果，如何评估灰度时间？华为终端支付灰度时长为3天，3天的灰度覆盖了多少场景，是否覆盖了本次版本修改的逻辑，灰度3天时间是否合理， OnTester灰度测试工具可以为确定灰度时间和策略提供数据信息。

### 1.2.2 OnTester灰度测试工具作用

1. 对灰度机器的所有请求进行精准校验，帮助挖掘版本问题：OnTester灰度测试工具不同于传统监控工具统计各种错误码信息，灰度测试工具验证灰度过程中的所有请求，实时展示所有请求的验证结果，对有问题的请求立刻返回failed，帮助用户及时发现版本问题。

2.  对于异常请求结果进行实时定位，缩短问题定位时间：运行结果详情页展示用例运行详细信息、原始请求，用户通过详情信息获取用例的failed或unmatched原因。

3.统计接口的各种场景分支的覆盖请求数、占比和请求验证情况，缩短灰度时间：工具统计灰度任务的所有请求覆盖情况，用户可以从页面中获取本次灰度是否覆盖了所有重要场景，获取关注的场景分支（如本次版本代码修改影响的场景分支）的覆盖情况，根据覆盖率和验证结果决策是否可以结束灰度阶段发布现网。

### 1.2.3 OnTester灰度测试工具原理

工具共有几大服务组成：design、run、DB查询服务、入库服务、请求收集插件。

1. 请求收集：请求收集插件支持基于tomcat容器的http/https请求、基于dubbo框架rpc请求。请求收集插件收集被测服务请求，并将请求发送给请求入库服务，入库服务将请求存入mongodb。

2. 用例设计：design将用户配置收敛字段将请求收敛成多个场景，保存在场景表，将用户根据场景生成的用例保存在用例表，将用例的检查点保存在数据库的检查点表。

3. 灰度发布任务调度：run根据任务配置的接口，通过代理请求DB查询服务，获取对应接口的原始请求，将请求匹配对应用例，执行用例的检查点进行校验，并将结果保存；并实时对灰度数据进行统计分析。
![OnTest灰度测试](images/ontest-001.PNG)

### 1.2.4 实践成效

华为支付V3.14.6.101版本应用了灰度测试工具，对首次两省级第一次灰度测试数据测试验证和统计分析。两省级灰度时长为72小时，OnTester灰度测试共覆盖11个接口521,803条原始请求。分析各接口及其测试用例，按用例出现次数加权覆盖比，灰度4小时内，6个接口100%覆盖，3个接口覆盖率>99%，2个接口覆盖率>97.9%，总覆盖比例高达99.60%。

![OnTest灰度测试](images/ontest-002.PNG)

### 1.2.5 详情

1. 在任务运行中，工具实时统计验证请求数、每个接口Passed、Failed、Unmatched次数，以及接口通过率。

![OnTest灰度测试](images/ontest-003.PNG)
![OnTest灰度测试](images/ontest-004.PNG)

2. 在任务运行中，工具统计各个接口的场景用例验证情况，及用例覆盖情况。如某接口13个用例，请求历史验证覆盖了6个场景用例，当前任务覆盖了4个场景，低于历时记录，ST错误场景明显增加。

![OnTest灰度测试](images/ontest-005.PNG)

3. 在任务运行中，工具展示所有请求的验证结果，并对异常结果展示了产生原因，并展示原始请求信息，为用 户初步定位提供便捷。如该用例验证failed，failed原因是检查点配置错误。签名错误有可能是签名不对，也有可能是签名为空，但检查点只配置了签名为空的情况。

![OnTest灰度测试](images/ontest-006.PNG)
