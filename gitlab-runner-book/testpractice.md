# 最佳实践

基于HC自动化流程和执行机的设计，关键设计不同执行机的部署（包含基础镜像+运行环境），并匹配不同的注册策略，确保满足流程要求。

## 总体设计

1. 部署架构
![部署架构](/images/practice-001.PNG)

2. 流程架构
![流程架构](/images/practice-002.PNG)

### CICD流程描述
1. Gitlab代码中心托管产品代码，以及流水线代码
2. 任何代码变更，自动触发流水线任务
3. 流水线执行流程
  - 准备主执行机（通过脚本创建主执行机，主执行机通过特定标签来构建不同类型的构建执行机集群，构建主机集群包含执行不同任务的执行机，并附带特定标签，用于执行不同的任务，并自动完成注册
  - 打包执行机：拉取代码，打包；支持docker 镜像包， rpm，压缩包等
  - 部署执行机：部署，更新相应服务（容器等）
  - 测试执行机：拉取测试套件，连接测试环境，运行测试套件

### 主执行机
负责创建打包执行机，部署执行机，以及测试执行机；按照标签来确定不同类型的构建执行机。构建执行机包含：
  1. 打包执行机
  2. 测试执行机
  3. 部署执行机

各类执行机关系，标签，及配置对比表:



### 打包执行机
  - 容器镜像<br>
  执行docker login， docker build，docker push指令。包含基本的docker环境，
  - rpm<br>
  执行xbuild（或其他rpm打包工具），比如Openstack的源码，使用社区的spec进行定义和打包，并支持s3客户端工具登录公司对象存储，完成传包任务
  - 压缩包<br>
  执行tar命令进行打包，并支持s3客户端工具登录公司对象春初，完成传包任务

### 部署执行机
  - 容器镜像<br>
  执行docker pull指令获取镜像库的容器镜像，docker run部署容器，包含基本的docker环境，
  - rpm<br>
  暂时不涉及，rpm的使用，封装在镜像构建脚本中； 基于对象存储的rpm包构建本地的yum源可以作为一部分任务，待决策；
- 压缩包<br>
  暂时不涉及，根据实际情况推送各类压缩包到相应的测试环境。

### 测试执行机
  - Openstack测试执行机<br>
  构建tempest测试主机，并执行相应测试结果。
  - Murano测试执行机<br>
  根据实际讨论解决，进行自动化测试

## Maruno集成
